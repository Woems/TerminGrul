<?php  class User  {    protected $db = null;    public function __construct()    {      global $db;      $this->db=$db;      session_start();    }    public function all()    {      $sth = $this->db->prepare('SELECT * FROM user');      $sth->execute();      $tmp = $sth->fetchAll(PDO::FETCH_ASSOC);      //$tmp["passwd"]="";      return $tmp;    }    public function bylogin($user, $passwd)    {      $sth = $this->db->prepare('SELECT * FROM user WHERE user=? AND passwd=MD5(?) AND verified=1');      $sth->execute(array($user, $passwd));      $tmp = $sth->fetch(PDO::FETCH_ASSOC);      if ($tmp["user"]!=$user) return false;      $tmp["passwd"]="***";      return $tmp;    }    public function byid($id)    {      $sth = $this->db->prepare('SELECT * FROM user WHERE id=?');      $sth->execute(array($id));      $tmp = $sth->fetch(PDO::FETCH_ASSOC);      $tmp["passwd"]="***";      return $tmp;    }    public function exist($name,$mail)    {      $sth = $this->db->prepare('SELECT count(*) FROM user WHERE user=? OR mail=?');      $sth->execute(array($name,$mail));      return $sth->fetchColumn();    }    public function create($user, $mail, $passwd, $activationcode)    {      $ret = $this->db->prepare("INSERT INTO user (`id`, `user`, `mail`, `passwd`, `activationcode`) VALUE(NULL, ?, ?, MD5(?), ?)");      $ret->execute(array($user, $mail, $passwd, $activationcode));      return true;    }    public function activate($activationcode)    {      if ($activationcode=="erl.") return 0;      $sth = $this->db->prepare('UPDATE user SET `verified` = 1, `activationcode`="erl." WHERE activationcode = ?');      $sth->execute(array($activationcode));      return $sth->rowCount();    }    public function setlastlogin($id)    {      $sth = $this->db->prepare('UPDATE user SET `lastlogin` = NOW() WHERE id = ?');      $sth->execute(array($id));      return $sth->fetch(PDO::FETCH_ASSOC);    }    public function login($user, $passwd)    {      $usr = $this->bylogin($user, $passwd);      if (!isset($usr) || !isset($usr["id"])) return false;      $this->setlastlogin($usr["id"]);      $_SESSION["id"]=$usr["id"];      return $usr;    }    public function logout()    {      unset($_SESSION["id"]);      return $this;    }    public function logedin()    {      if (!isset($_SESSION["id"])) return false;      $usr = $this->byid($_SESSION["id"]);      if (!isset($usr) || !isset($usr["id"])) return false;      $this->setlastlogin($usr["id"]);      return $usr;    }  }?>